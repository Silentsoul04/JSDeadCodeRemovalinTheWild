YUI.add("hermes-lang-comments",function(e,o){e.Intl.add("hermes/comments","en-US",{LOADING:["Loading"],MORE:["more"],ERROR_LOADING_COMMENTS:["Error loading comments"],COULDNT_POST_COMMENT:["We couldn't post your comment"],COULDNT_GET_MORE_COMMENTS:["We couldn't get more comments"],CONFIRM_DELETE:["Confirm Delete"],YES_CONFIRM_DELETE:["Yes, Delete It"],ARE_YOU_SURE_DELETE:["Are you sure you want to delete this comment?"],COULDNT_DELETE_COMMENT:["We couldn't delete your comment"],ERROR:["Error!"],NO_COMMENTS:["No comments"],ADD_A_COMMENT:["Add a comment"],LOGIN_TO_COMMENT:["Login to comment"],MUST_BE_LOGGED_IN_TO_COMMENT:["You must be logged in to post a comment"],LOADING_COMMENTS:["Loading comments..."],SEE_MORE:["See more"],SEE_MORE_LINK:['... <a href="',"${photoUrl}",'">Read more</a>'],SIGNUP_MODAL_TITLE:["Comment on this photo!"],SIGNUP_MODAL_MESSAGE:["Join Flickr to leave a comment on this photo"],VIEW_COMMENTS:["View Comments"],COMMENTING_DISABLED:["Commenting is disabled for this photo."],VIEW_ON_PHOTO_PAGE:["View all comments on the photo page"],ADD_GALLERY_COMMENT:["Add a comment about this gallery"],ADD_PHOTO_COMMENT:["Add a comment about this ",{type:"select",valueName:"mediaType",options:{photo:["photo"],video:["video"],other:["photo"]}}],SELECT_EMOJI:["Select emoji"]})},"@VERSION@",{requires:["intl"]});YUI.add("comment-list-view",function(e,t){var n=require("hermes-core/flog")(t);e.namespace("Views")["comment-list-view"]=e.Base.create("comment-list-view",e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){this.params=e,this.modelConfig=e.commentListConfig,this.perPage=this.modelConfig.perPage||16,this.firstPerPage=this.modelConfig.firstPerPage||16,this.commentsPage=0,this.renderedCommentModels=[],this.isSubjectOwner=!1},activate:function(){var e=this.get("container");return e.addClass("comment-list-view"),this.commentsListNode=e.one(".comment-list"),this.registerEventHandler(this.commentsListNode.delegate("click",this.handleCommentActionClick.bind(this),".comment-actions")),this.loadComments()},resetComments:function(){return this.renderedCommentModels=[],this.commentsPage=0,this.commentsListNode.set("innerHTML",""),this.loadComments()},loadComments:function(){var t=this,o=t.appContext.getViewer().nsid,i=t.appContext.getViewer().signedIn,m=[this.appContext.getModelRegistry(this.modelConfig.commentModelRegistryName).then(function(e){t.commentModelRegistry=e}),this.appContext.getModel(this.modelConfig.listRegistryName,{id:this.modelConfig.modelId}).then(function(e){t.listModel=e})];switch(this.modelConfig.listRegistryName){case"gallery-info-models":m.push(this.appContext.getModel(this.modelConfig.listRegistryName,{id:this.modelConfig.modelId}).then(function(e){t.isSubjectOwner=i&&o===e.getValue("owner").getValue("nsid")}));break;case"photo-comments-models":m.push(this.appContext.getModel("photo-models",this.modelConfig.modelId).then(function(e){t.isSubjectOwner=o===e.getValue("owner").getValue("nsid")})),m.push(this.appContext.getModel("photo-engagement-models",this.params.photoId).then(function(e){t.engagementModel=e}))}return e.Promise.all(m).then(function(e){var n=t.listModel.getValue(t.modelConfig.collectionName).getList();return t.commentsPage=Math.ceil(n.length/t.perPage),"-1"===t.listModel.getValue(t.modelConfig.listRegistryContinuationName)&&(t.endOfComments=!0),0!==n.length?t.updateComments(n):t.getComments()}).then(function(){var e=t.get("container").all("img.notsowide"),n=e._nodes.length,o=0;0===n?t.handleLoadCommentsComplete():e.on(["load","error"],function(e){++o===n&&t.handleLoadCommentsComplete()})}).catch(function(e){n.error("Error getting info",{err:e})})},getComments:function(){var t,o=this;return this.endOfComments?e.Promise.resolve():(this.isFetchingComments=!0,"gallery"===this.modelConfig.type?t=this.getGalleryComments():"photo"===this.modelConfig.type&&(t=this.getPhotoComments()),t.then(function(){o.isFetchingComments=!1}).catch(function(e){n.error("Error getting comments",{err:e}),o.isFetchingComments=!1}))},getGalleryComments:function(){var e=this,t=this.notFirstPage?this.perPage:this.firstPerPage,n=this.listModel.getValue(e.modelConfig.collectionName).getList(),o=this.renderedCommentModels.length,i=[];if(n.length>o+t){for(var m=o;m<o+t;m++)i.push(n[m]);return e.updateComments(i)}return this.listModel.getCommentsByContinuation(t).then(function(t){return e.notFirstPage=!0,"-1"===e.listModel.getValue(e.modelConfig.listRegistryContinuationName)&&(e.endOfComments=!0),e.updateComments(t)})},getPhotoComments:function(){var t=this;return 0===this.engagementModel.getValue("commentCount")?(this.endOfComments=!0,e.Promise.resolve()):this.listModel.getValue(this.modelConfig.collectionName).getRange({offset:this.listModel.getValue(this.modelConfig.collectionName).getList().length,limit:this.perPage}).then(function(e){return t.commentsPage++,e.length<16&&(t.endOfComments=!0),t.updateComments(e)})},getMoreComments:function(){var t=this;return this.endOfComments?e.Promise.resolve():(this.showCommentLoading(!0),this.getComments().then(function(){t.showCommentLoading(!1)}))},showBalls:function(t){this.balls||(this.balls=e.Node.create('<li class="loading-balls"></li>'),this.balls.setHTML(this.templates("flickr-balls")({}))),t?(this.balls.addClass("bottom"),this.commentsListNode.append(this.balls)):this.commentsListNode.prepend(this.balls)},hideBalls:function(){this.balls&&(this.balls.removeClass("bottom"),this.balls.remove())},appendNewComment:function(t){var n=this,o=Object.assign(t.toJSON(),{appContext:this.appContext}),i=new e.Views["comment-item-view"](o);i.initialize(o).then(function(){i.activate()}).then(function(){var t=e.Node.create('<li class="comment-list-item"></li>');t.append(i.get("container")),n.commentsListNode.append(t),n.showCommentAddLoading(!1)}).then(function(){n.handleCommentViewAppended(i)})},handleCommentActionClick:function(e){var t=e.target,n=t.ancestor(".comment-item"),o=n.getAttribute("data-id");t.ancestor(".comment-action-menu-button",!0)&&this.showCommentActionMenu(o,n,t.ancestor(".comment-action-menu-button",!0).getAttribute("data-menutype")),t.ancestor(".comment-action-reply-button",!0)&&(e.preventDefault(),this.fire("subviewViewEvent",{eventName:"replyClicked",pathAliasOrNSID:t.ancestor(".comment-action-reply-button",!0).getAttribute("data-pathalias")}))},showCommentActionMenu:function(t,n,o){var i=this,m=[{text:this.intlMessage({intlName:"common.DELETE"}),value:"delete-comment-action"}];"owner"===o&&m.push({text:this.intlMessage({intlName:"common.EDIT"}),value:"edit-comment-action"}),n.addClass("active"),this.commentActionMenu||(this.commentActionMenu=new e.Views.FluidDroparound({appContext:this.appContext,dismissOnActionClick:!0,showDropArrow:!0,anchorElement:n.one(".comment-action-menu-button"),anchorOffsetHorizontal:11,classList:"over-modal comment-action-menu",overlayClassList:"over-modal",menuItems:m}),this.commentActionMenu.show(),this.registerEventHandler(this.commentActionMenu.on("closeDroparound",function(e){n.removeClass("active"),i.commentActionMenu=null})),this.registerEventHandler(this.commentActionMenu.on("selected",function(e){i.commentActionMenu.close(),"delete-comment-action"===e.menuItem.value?i.deleteComment(t,n):"edit-comment-action"===e.menuItem.value&&i.showEditComment(t,n)})))},deleteComment:function(e,t){return t.ancestor("li").remove(),this.deleteCommentCall(e)},deleteCommentCall:function(e){return"gallery"===this.modelConfig.type?this.deleteGalleryComment(e):"photo"===this.modelConfig.type?this.deletePhotoComment(e):void 0},showEditComment:function(e,t){var o=this,i=t.one(".content-container"),m=i.one(".comment-content");if(!this.isEditingComment)return this.isEditingComment=!0,this.commentModelRegistry.get(e).then(function(t){var s,l=m.get("offsetHeight");m.hide(),i.append(o.templates("comment-edit")({content:t.getValue("contentRaw")})),o.editCommentNode=i.one(".comment-edit"),(s=o.editCommentNode.one(".edit-field")).setStyle("height",Math.min(Math.max(l,100),200)),s.select(),o.registerEventHandler(o.editCommentNode.one(".cancel-edit-button").on("click",function(){m.show(),o.editCommentNode.remove(),o.isEditingComment=!1})),o.registerEventHandler(o.editCommentNode.one(".submit-edit-button").on("click",function(){o.updateComment(e,s.get("value"),m).then(function(e){m.set("innerHTML",e.getValue("contentSecure")),m.show(),o.editCommentNode.remove(),o.isEditingComment=!1}).catch(function(e){n.error("Error editing comment",{err:e}),m.show(),o.editCommentNode.remove(),o.isEditingComment=!1})}))})},updateComment:function(e,t){return this.updateCommentCall(e,t)},updateCommentCall:function(e,t){return"gallery"===this.modelConfig.type?this.updateGalleryComment(e,t):"photo"===this.modelConfig.type?this.updatePhotoComment(e,t):void 0},deleteGalleryComment:function(e){return this.commentModelRegistry.deleteRemote(e)},deletePhotoComment:function(e){var t=this;return this.commentModelRegistry.remoteDelete(e).then(function(){t.fire("subviewViewEvent",{eventName:"commentDeleted",commentModelId:e})})},updateGalleryComment:function(e,t){return this.commentModelRegistry.updateRemote(e,t)},updatePhotoComment:function(e,t){var n=this;return this.commentModelRegistry.get(e).then(function(o){return o.setValue("content",t),n.commentModelRegistry.remoteUpdate(e)})},delayPromise:function(t,n){return new e.Promise(function(e){setTimeout(function(){return e(n())},t)})},setLoading:function(e){this.isLoading=e},updateComments:function(e){},handleCommentViewAppended:function(){},showCommentLoading:function(){},showCommentAddLoading:function(){}})},"@VERSION@",{requires:["flickr-view","comment-item-view"],langBundles:["gallery","stats","comments","common"]});YUI.add("hermes-template-scrollable-comment-list-view",function(e,a){var s=e.Template.Handlebars.revive({compiler:[7,">= 4.0.0"],main:function(e,a,s,t,l){var n=null!=a?a:{},i=s.helperMissing,m=e.escapeExpression;return'<div class="comment-list-container loading">\n\t<ol class="comment-list">\n\t</ol>\n\t<div class="loading-text">'+m((s.intlMessage||a&&a.intlMessage||i).call(n,{name:"intlMessage",hash:{intlName:"comments.LOADING_COMMENTS"},data:l}))+'</div>\n\t<div class="no-comments-text">'+m((s.intlMessage||a&&a.intlMessage||i).call(n,{name:"intlMessage",hash:{intlName:"comments.NO_COMMENTS"},data:l}))+"</div>\n</div>"},useData:!0}),t={};e.Array.each([],function(a){var s=e.Template.get("hermes/"+a);s&&(t[a]=s)}),e.Template.register("hermes/scrollable-comment-list-view",function(a,l){return l=l||{},l.partials=l.partials?e.merge(t,l.partials):t,s(a,l)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("scrollable-comment-list-view",function(t,e){var s=require("hermes-core/flog")(e);t.namespace("Views")[this.name]=t.Base.create(this.name,t.Views["comment-list-view"],[],{langBundles:this.details.langBundles,initializer:function(t){this.constructor.superclass.initializer.call(this,t),this.listRegistryName=t.commentListConfig.listRegistryName,this.listId=t.commentListConfig.modelId},loadState:function(){var t=this;return t.appContext.getModel(t.listRegistryName,{id:t.listId}).then(function(e){t.commentListModel=e}).catch(function(t){throw s.error("Error getting comment list info",{err:t}),t})},buildContainer:function(){this.setContainerWithTemplate("scrollable-comment-list-view",this.params)},activate:function(){var t=this.get("container");this.listContainerNode=t.one(".comment-list-container"),this.scrollableEl=this.listContainerNode.getDOMNode(),this.registerEventHandler(this.commentListModel.on("valuesChanged",this.handleCommentListChange.bind(this),!0)),this.constructor.superclass.activate.call(this)},handleCommentListChange:function(t){0===t.comments.newVal.getList().length?this.showNoCommentsMessage():this.listContainerNode.removeClass("no-comments")},showNoCommentsMessage:function(){var t=this;this.listContainerNode.addClass("no-comments"),setTimeout(function(){t.fire("subviewViewEvent",{eventName:"emptyCommentContainer"})},300)},getNumOfComments:function(){return this.commentListModel.getValue(this.params.commentListConfig.collectionName).getList().length},setLoading:function(t){this.isLoading=t,this.listContainerNode.toggleClass("loading",t)},handleLoadCommentsComplete:function(){this.listContainerNode.removeClass("loading"),0===this.getNumOfComments()&&this.showNoCommentsMessage(),this.scrollableEl.scrollTop=this.scrollableEl.scrollHeight,this.registerEventHandler(this.listContainerNode.on("scroll",this.handleCommentsScroll.bind(this)))},appendNewComment:function(t){0===this.getNumOfComments()&&this.listContainerNode.removeClass("no-comments"),this.constructor.superclass.appendNewComment.call(this,t)},handleCommentsScroll:function(t){!this.isFetchingComments&&this.scrollableEl.scrollTop<=0&&this.getMoreComments()},showCommentLoading:function(t){t?this.showBalls(!1):this.hideBalls()},showCommentAddLoading:function(t){t?(this.showBalls(!0),this.scrollableEl.scrollTop=this.scrollableEl.scrollHeight):this.hideBalls()},handleCommentViewAppended:function(t){this.scrollableEl.scrollTop=this.scrollableEl.scrollHeight},updateComments:function(t){var e=this;return t.forEach(function(t){e.renderedCommentModels.push(t)}),this.prependComments(t)},prependComments:function(e){var s=this,i=[],n=[];return e.forEach(function(e){var o=e.toJSON(),l=Object.assign(o,{appContext:this.appContext});l.isSubjectOwner=s.isSubjectOwner;var a=new t.Views["comment-item-view"](l),m=a.initialize(l).then(function(){a.activate()});n.push(a),i.push(m)}),t.Promise.all(i).then(function(){s.prependCommentViewsToDom(n)})},prependCommentViewsToDom:function(e){var s,i=this,n=this.scrollableEl,o=n.scrollHeight,l=n.scrollTop;e.forEach(function(e){(s=t.Node.create('<li class="comment-list-item"></li>')).append(e.get("container")),i.commentsListNode.prepend(s)}),n.scrollTop=n.scrollHeight-o+l}})},"@VERSION@",{requires:["flickr-view","comment-list-view","hermes-template-scrollable-comment-list-view"],langBundles:["common","comments"]});YUI.add("hermes-template-photo-comments-view",function(e,t){var a=e.Template.Handlebars.revive({compiler:[7,">= 4.0.0"],main:function(e,t,a,n,s){var l=null!=t?t:{},o=a.helperMissing,i=e.escapeExpression;return'<section class="comments-list-section">\n\t'+i((a.outlet||t&&t.outlet||o).call(l,null!=t?t["scrollable-comment-list-view"]:t,{name:"outlet",hash:{},data:s}))+'\n</section>\n\n<section class="add-comment-section">\n\t'+i((a.outlet||t&&t.outlet||o).call(l,null!=t?t["add-comment-view"]:t,{name:"outlet",hash:{},data:s}))+"\n</section>\n"},useData:!0}),n={};e.Array.each([],function(t){var a=e.Template.get("hermes/"+t);a&&(n[t]=a)}),e.Template.register("hermes/photo-comments-view",function(t,s){return s=s||{},s.partials=s.partials?e.merge(n,s.partials):n,a(t,s)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("hermes-template-comment-edit",function(t,e){var n=t.Template.Handlebars.revive({compiler:[7,">= 4.0.0"],main:function(t,e,n,a,s){var i,l=null!=e?e:{},m=n.helperMissing,o=t.escapeExpression;return'<div class="comment-edit">\n\t<textarea class="edit-field">'+o("function"==typeof(i=null!=(i=n.content||(null!=e?e.content:e))?i:m)?i.call(l,{name:"content",hash:{},data:s}):i)+'</textarea>\n\t<div class="buttons edit-comment-buttons">\n\t\t<button type="button" class="mini alt cancel-edit-button">'+o((n.intlMessage||e&&e.intlMessage||m).call(l,{name:"intlMessage",hash:{intlName:"common.CANCEL"},data:s}))+'</button>\n\t\t<button type="button" class="mini action submit-edit-button">'+o((n.intlMessage||e&&e.intlMessage||m).call(l,{name:"intlMessage",hash:{intlName:"common.DONE"},data:s}))+"</button>\n\t</div>\n</div>"},useData:!0}),a={};t.Array.each([],function(e){var n=t.Template.get("hermes/"+e);n&&(a[e]=n)}),t.Template.register("hermes/comment-edit",function(e,s){return s=s||{},s.partials=s.partials?t.merge(a,s.partials):a,n(e,s)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("photo-comments-view",function(e,t){require("hermes-core/flog")(t);e.namespace("Views")[this.name]=e.Base.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){this.params=e,this.params.commentListConfig={type:"photo",listRegistryName:"photo-comments-models",modelId:e.photoId,collectionName:"comments",commentModelRegistryName:"comment-models"},this.params.addCommentConfig={type:"photo",commentModelRegistryName:"comment-models",addCommentText:e.addCommentText||this.intlMessage({intlName:"comments.ADD_PHOTO_COMMENT",mediaType:"photo"})},this.commentsPage=0,this.signedIn=this.appContext.getViewer().signedIn},subviewConfig:{"scrollable-comment-list-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!1},"add-comment-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!1}},loadState:function(){var t=this,o=[this.appContext.getModelRegistry("comment-models").then(function(e){t.commentModelRegistry=e}),this.appContext.getModel("photo-engagement-models",this.params.photoId).then(function(e){this.engagementModel=e}.bind(this)),this.appContext.getModel(this.params.commentListConfig.listRegistryName,this.params.commentListConfig.modelId).then(function(e){t.listModel=e})];return this.signedIn&&o.push(this.appContext.getModel("person-models",{id:this.appContext.getViewer().nsid}).then(function(e){t.userModel=e})),e.Promise.all(o)},buildContainer:function(){this.setContainerWithTemplate("photo-comments-view",{user:this.signedIn?this.userModel.toJSON():null,signedIn:this.signedIn})},activate:function(){this.get("container");this.commentListView=this.subviews["scrollable-comment-list-view"],this.addCommentView=this.subviews["add-comment-view"]},delayPromise:function(t,o){return new e.Promise(function(e){setTimeout(function(){return e(o())},t)})},onSubviewEvent:function(t,o){var n;if(o&&o[0])switch((n=o[0]).eventName){case"replyClicked":this.addCommentView.addReplyMessage(n.pathAliasOrNSID,!1);break;case"emptyCommentContainer":this.addCommentView.focusCommentBox();break;case"commentAddLoading":e.rapidTracker.beacon(this.name,"galleryPhotoCommentAddClick"),this.commentListView.showCommentAddLoading(n.isLoading);break;case"commentAdded":this.commentListView.appendNewComment(n.commentModel),this.listModel.getValue(this.params.commentListConfig.collectionName).prependToList(n.commentModel),this.engagementModel.setValue("commentCount",this.engagementModel.getValue("commentCount")+1);break;case"commentDeleted":this.listModel.getValue(this.params.commentListConfig.collectionName).removeFromList(n.commentModelId),this.engagementModel.setValue("commentCount",this.engagementModel.getValue("commentCount")-1)}}})},"@VERSION@",{requires:["flickr-view","comment-item-view","add-comment-view","scrollable-comment-list-view","hermes-template-photo-comments-view","hermes-template-comment-edit"],langBundles:["gallery","stats","comments","common"]});