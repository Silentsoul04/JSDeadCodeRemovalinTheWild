import { Application } from 't3js';
import bzfd from '../../js/services/bzfd';
import { closest } from '@buzzfeed/buzzblocks/js/services/dom';


const ADVERT_INDIA_URL = 'https://advertise.buzzfeed.com/bfindia';


/**
 * "Advertise with BuzzFeed" links
 */
const linkAdvertise = (context) => {
  const config = context.getConfig();
  const element = context.getElement();
  const adElement = closest(element, `.js-ad-${config.wid}`);
  const linkTag = element.querySelector('a');
  /**
   * updates `link` for special cases
   * and any special cases for countries
   * @return {void}
   */
  const _updateCountry = () => {
    const country = bzfd.localization.country;
    // India special case
    if(country === 'en-in') {
      linkTag.href = ADVERT_INDIA_URL;
    }
  };

  /**
   * Un-hides link.
   * @return {void}
   */
  const _displayLink = () => {
    if (!adElement) {
      return;
    }
    // only display after 3rd story in feed
    if (adElement.dataset.module === 'ad-feed-story') {
      let allStoryAds = document.querySelectorAll('[data-module=ad-feed-story]') || [];
      if ((Array.prototype.indexOf.call(allStoryAds, adElement) + 1) !== 3) {
        return;
      }
    }
    // unhide link to allow us to get offsetHeight
    element.classList.remove('js-hidden');
    element.style.visibility = 'none';
    // fix bottom margin
    const linkHeight = element.offsetHeight + 4;
    element.style.bottom = -linkHeight + 'px';
    if (adElement.parentElement.classList.contains('ad-wireframe-wrapper')) {
      const bottomMargin = parseInt(window.getComputedStyle(adElement.parentElement)['margin-bottom'], 10);
      const adPadding = `<div class="js-padding" style="margin-bottom: ${linkHeight + bottomMargin}px"></div>`;
      adElement.parentElement.insertAdjacentHTML('beforeend', adPadding);
    } else {
      const adPadding = `<div class="js-padding" style="padding-bottom: ${linkHeight}px; margin: 0"></div>`;
      adElement.insertAdjacentHTML('afterEnd', adPadding);
    }
    // display link
    element.style.visibility = 'visible';
  };

  /**
   * Notifies DataDog in case of click event.
   * @param {Object} e - click event
   * @return {void}
   */
  const _trackClick = (e) => {
    e.stopPropagation();
    Application.broadcast(`advertise-click-${config.wid}`, { url: linkTag.href });
  };

  return {
    init() {
      _updateCountry();
      _displayLink();
    },
    'onclick': _trackClick
  };
};

Application.addModule('link-advertise', linkAdvertise);
